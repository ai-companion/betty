name: Cursor Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  cursor-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check for WIP commit
        id: check-wip
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Last commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" == \[wip\]* ]] || [[ "$COMMIT_MSG" == \[WIP\]* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping review: commit marked as work in progress"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Cursor CLI
        if: steps.check-wip.outputs.skip != 'true'
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git identity
        if: steps.check-wip.outputs.skip != 'true'
        run: |
          git config user.name "Cursor Agent"
          git config user.email "cursoragent@cursor.com"

      - name: Perform automated code review
        if: steps.check-wip.outputs.skip != 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: gpt-5.3-codex
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BLOCKING_REVIEW: ${{ vars.BLOCKING_REVIEW || 'false' }}
        run: |
          agent --force --model "$MODEL" --output-format=text --print 'You are operating in a GitHub Actions runner performing automated code review. The gh CLI is available and authenticated via GH_TOKEN. You may comment on pull requests.

          Context:
          - Repo: ${{ github.repository }}
          - PR Number: ${{ github.event.pull_request.number }}
          - PR Head SHA: ${{ github.event.pull_request.head.sha }}
          - PR Base SHA: ${{ github.event.pull_request.base.sha }}
          - Blocking Review: ${{ env.BLOCKING_REVIEW }}

          Objectives:
          1) Re-check existing review comments and reply resolved when addressed.
          2) Review the current PR diff and flag only clear, high-severity issues.
          3) Leave very short inline comments (1-2 sentences) on changed lines only and a brief summary at the end.

          Procedure:
          - Get ALL existing review context before analyzing:
            - Top-level PR comments: gh pr view --json comments
            - All review comments and their reply threads: gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments --paginate
            - All submitted reviews with their bodies: gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --paginate
          - Read and understand the full conversation context. Pay close attention to:
            - Human replies to review comments ‚Äî if a reviewer or the PR author has replied saying an issue is not relevant, acknowledged, or already addressed, do NOT re-raise that same issue.
            - Resolved review threads ‚Äî do not comment on issues that have already been discussed and dismissed.
            - Any context from the PR author explaining design decisions or trade-offs.
          - Get diff: gh pr diff
          - Get changed files with patches to compute inline positions: gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --paginate --jq '\''.[] | {filename,patch}'\''
          - Compute exact inline anchors for each issue (file path + diff position). Comments MUST be placed inline on the changed line in the diff, not as top-level comments.
          - Detect prior top-level "no issues" style comments authored by this bot (match bodies like: "‚úÖ no issues", "No issues found", "LGTM").
          - If CURRENT run finds issues and any prior "no issues" comments exist:
            - Prefer to remove them to avoid confusion:
              - Try deleting top-level issue comments via: gh api -X DELETE repos/${{ github.repository }}/issues/comments/<comment_id>
              - If deletion is not possible, minimize them via GraphQL (minimizeComment) or edit to prefix "[Superseded by new findings]".
            - If neither delete nor minimize is possible, reply to that comment: "‚ö†Ô∏è Superseded: issues were found in newer commits".
          - If a previously reported issue appears fixed by nearby changes, reply: ‚úÖ This issue appears to be resolved by the recent changes
          - Analyze ONLY for:
            - Null/undefined dereferences
            - Resource leaks (unclosed files or connections)
            - Injection (SQL/XSS)
            - Concurrency/race conditions
            - Missing error handling for critical operations
            - Obvious logic errors with incorrect behavior
            - Clear performance anti-patterns with measurable impact
            - Definitive security vulnerabilities
          - Avoid duplicates: skip if similar feedback already exists on or near the same lines.

          Commenting rules:
          - Max 10 inline comments total; prioritize the most critical issues
          - One issue per comment; place on the exact changed line
          - All issue comments MUST be inline (anchored to a file and line/position in the PR diff)
          - Natural tone, specific and actionable; do not mention automated or high-confidence
          - Use emojis: üö® Critical üîí Security ‚ö° Performance ‚ö†Ô∏è Logic ‚úÖ Resolved ‚ú® Improvement

          Signature:
          - Append a signature at the end of every summary comment and every "no issues" comment.
          - The signature MUST be on its own lines, separated by a blank line and a Markdown horizontal rule. Use actual newlines, NOT literal backslash-n escape sequences.
          - Example of correct signature appended to a summary:
              Some review summary text here.

              ---
              ü§ñ *Reviewed by Cursor Agent (gpt-5.3-codex)*

          Submission:
          - EVERY review submission MUST have a non-empty body with the signature appended. Never submit a review with an empty body.
          - If there are NO new issues to report:
            - Check if a prior "no issues" summary comment already exists (e.g., "‚úÖ no issues", "No issues found", "LGTM").
            - If one exists, do NOT submit another. Skip submission entirely.
            - If none exists, submit a single top-level comment (via gh pr comment) with a brief "no new issues" message and the signature.
          - If there ARE issues to report:
            - If a prior "no issues" comment exists, delete/minimize/mark it as superseded first.
            - Submit ONE review via the GitHub Reviews API containing inline comments and a concise summary body with the signature.
            - Build a JSON array of comments like: [{ "path": "<file>", "position": <diff_position>, "body": "..." }]
            - Submit via: gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews -f event=COMMENT -f body="$SUMMARY" -f comments='\''[$COMMENTS_JSON]'\''
          - Do NOT use: gh pr review --approve or --request-changes

          Blocking behavior:
          - If BLOCKING_REVIEW is true and any üö® or üîí issues were posted: echo "CRITICAL_ISSUES_FOUND=true" >> $GITHUB_ENV
          - Otherwise: echo "CRITICAL_ISSUES_FOUND=false" >> $GITHUB_ENV
          - Always set CRITICAL_ISSUES_FOUND at the end
          '

      - name: Check blocking review results
        if: steps.check-wip.outputs.skip != 'true' && vars.BLOCKING_REVIEW == 'true'
        run: |
          echo "Checking for critical issues..."
          echo "CRITICAL_ISSUES_FOUND: ${CRITICAL_ISSUES_FOUND:-unset}"

          if [ "${CRITICAL_ISSUES_FOUND:-false}" = "true" ]; then
            echo "‚ùå Critical issues found and blocking review is enabled. Failing the workflow."
            exit 1
          else
            echo "‚úÖ No blocking issues found."
          fi
